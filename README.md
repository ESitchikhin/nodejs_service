# Example Node.js Service 

## Сервис генерации PDF-презентаций

Сервис генерации PDF-презентаций по заданному шаблону. Сервис дожлен  генерировать PDF-презентацию по заданным на вход данным: 
- шаблон дизайна - один из доступных в сервисе шаблонов (реализован один шаблон);
- набор и порядок инфоблоков, которые нужно поместить - (каждый шаблон включает инфоблоки, которые могут быть включены или выключены из итогового PDF-документа);
- данные об объекте - реальные данные, которые должны быть размещены в итоговом PDF-документе.

Корме этого сервис валидирует исходные данные - достаточно ли исходных данных об объекте для отображения каждого из инфобоков шаблона. И если каких-либо данных не достаточно, то сервис должен сообщить, каких именно данных об объекте не хватает для данного инфоблока.


## Порядок работы сервиса

Web-сервис отвечает на следующие endpoints
При запуске можно задать через переменные окружения следуюшие параметры:
```
# Данные для запуска сервиса (хост, порт и протокол)
PROTOCOL = http
HTTP_PORT = 8000
HTTPS_PORT = 8443
HTTP_HOST = 0.0.0.0

# Google Api Key для получения и печати в презентацию карты по координтам расположения объекта
GOOGLE_API_KEY=

# Service data
MEDIA_SERVICE - URL медиа-сервиса для получения изображений, которые необходимо отобразить в презентации

CALLBACK_URL - URL на который нужно будет отправить PDF-презентацию post запросом FormData

# Авторизационные данные, которые должны быть в headers в ответе с презентацией, если они заданы (пары ключи заголовков и значения ключей)
CLIENT_ID 
CLIENT_KEY
CLIENT_ID_HEADER=nrg-client-id
CLIENT_KEY_HEADER=nrg-client-key

# если задан, то ключ и значение, которые должны быть в заголовке, чтобы сервис обработал запрос. Если не задано, то обрабатываются все запросы
SECRET=
SECRET_HEADER=token

# Log files
ROOT_PATH = project

# BASE_LOG_DIR - path to log files from root path
IS_LOGGED = Y
BASE_LOG_DIR = logs
REQUEST_LOG_FILE = request.log

# for example, sslcert/server.key
PRIVATE_KEY =

# for example, sslcert/server.crt
CERTIFICATE =
```

## Предоставить доступные шаблоны презентаций по переданному типу презентации

```
POST /api/v1/pdf/get-templates/
{ 
	dataType: 'singleOffer' | 'multipleOffers' | 'singleObject' |	'multipleObjects' | 'singleRealty' |	'multipleRealties';
} 
```
Отвечает перечнем доступных шаблонов.

## Предоставить список инфоблоков в шаблоне 
```
POST /api/v1/pdf/get-blocks/
{ 
	templateId: string,
	data: TRealtyData,
	broker: TBroker,
} 
```
- data - исходные данные об объекте
- broker - исходные данные о брокере

Отвечает списокм доступных для указанного шаблона инфоблоков, представленном в порядке "по-умолчанию". Если для какого-либо из инфо-блоков исходной информации не достаточно, то в ответе будет перечень недостающих данных.
```
{
	blocks: TBlock[]
}
```
Порядок инфоблоков - по-умолчанию для шаблона.

## Создать PDF-презентацию 
```
POST /api/v1/pdf/create/
{ 
	templateId: string,
	isGreyscalePhotos: boolean,
	isNdsInclude: boolean,
	data: TRealtyData,
	broker: TBroker,
} 
```
- isGreyscalePhotos - если true, то все внешние изображения будут преобразованы в черно-белые (точнее, greyscale)
- isNdsInclude - если true, то расчет стоимостей, заложенный в логику работы сервиса, будет производится из учета, что переданы цены уже с НДС

Ответ: 
Если данные валидны, то сервис отвечает статусом 204 и запускает создание презентации. После того, как презентация будет создана, сервис отправит PDF-файл на заданный callback url в формате FormData c вложенным файлом, после сам pdf-файл, а также все загруженные и преобразованные внешние изображения будут удалены.
